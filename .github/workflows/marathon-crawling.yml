name: Marathon Crawling Monthly Job

on:
  schedule:
    # 매월 1일 오전 9시 KST (= UTC 0시)
    - cron: '0 0 1 * *'
  workflow_dispatch: # 수동 실행 허용

jobs:
  crawl:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'

    - name: Install system dependencies (Chrome and ChromeDriver)
      run: |
        sudo apt-get update
        sudo apt-get install -y chromium-browser chromium-chromedriver
        sudo ln -sf /usr/lib/chromium-browser/chromedriver /usr/local/bin/chromedriver

    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create .env file from secrets
      env:
        MYSQL_HOSTNAME: ${{ secrets.MYSQL_HOSTNAME }}
        MYSQL_USER: ${{ secrets.MYSQL_USER }}
        MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
        MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
        MYSQL_TABLE: ${{ secrets.MYSQL_TABLE }}
        OPTION_ARGUMENTS: ${{ secrets.OPTION_ARGUMENTS }}
        OUTPUT_CSV_FILE_NAME: ${{ secrets.OUTPUT_CSV_FILE_NAME }}
      run: |
        {
          printf '%s\n' "MYSQL_HOSTNAME=${MYSQL_HOSTNAME}"
          printf '%s\n' "MYSQL_USER=${MYSQL_USER}"
          printf '%s\n' "MYSQL_PASSWORD=${MYSQL_PASSWORD}"
          printf '%s\n' "MYSQL_DATABASE=${MYSQL_DATABASE}"
          printf '%s\n' "MYSQL_TABLE=${MYSQL_TABLE}"
          printf '%s\n' "OPTION_ARGUMENTS=${OPTION_ARGUMENTS}"
          printf '%s\n' "OUTPUT_CSV_FILE_NAME=${OUTPUT_CSV_FILE_NAME}"
          printf '%s\n' "CHROMEDRIVER_PATH="
        } > .env

    - name: Run marathon crawling script
      run: python marathon-crawling.py

    - name: Upload CSV artifact (optional)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: marathon-data
        path: '*.csv'
        retention-days: 30

    - name: Send Discord notification on success
      if: success()
      run: |
        curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
          -H "Content-Type: application/json" \
          -d '{
            "embeds": [{
              "title": "✅ Marathon Crawling 성공",
              "description": "마라톤 크롤링 작업이 성공적으로 완료되었습니다.",
              "color": 3066993,
              "fields": [
                {
                  "name": "Repository",
                  "value": "'"${{ github.repository }}"'",
                  "inline": true
                },
                {
                  "name": "Branch",
                  "value": "'"${{ github.ref_name }}"'",
                  "inline": true
                },
                {
                  "name": "Commit",
                  "value": "['"${GITHUB_SHA:0:7}"']('"${{ github.event.head_commit.url }}"')",
                  "inline": true
                },
                {
                  "name": "실행 시각",
                  "value": "'"$(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S KST')"'",
                  "inline": false
                }
              ],
              "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
            }]
          }'

    - name: Send Discord notification on failure
      if: failure()
      run: |
        curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
          -H "Content-Type: application/json" \
          -d '{
            "embeds": [{
              "title": "❌ Marathon Crawling 실패",
              "description": "마라톤 크롤링 작업이 실패했습니다.",
              "color": 15158332,
              "fields": [
                {
                  "name": "Repository",
                  "value": "'"${{ github.repository }}"'",
                  "inline": true
                },
                {
                  "name": "Branch",
                  "value": "'"${{ github.ref_name }}"'",
                  "inline": true
                },
                {
                  "name": "Commit",
                  "value": "['"${GITHUB_SHA:0:7}"']('"${{ github.event.head_commit.url }}"')",
                  "inline": true
                },
                {
                  "name": "실행 시각",
                  "value": "'"$(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S KST')"'",
                  "inline": false
                },
                {
                  "name": "로그 확인",
                  "value": "[GitHub Actions 로그 보기]('"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"')",
                  "inline": false
                }
              ],
              "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
            }]
          }'
